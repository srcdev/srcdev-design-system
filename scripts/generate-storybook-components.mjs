#!/usr/bin/env node

import { readFile, writeFile } from "fs/promises"
import { resolve } from "path"

/**
 * Auto-generates component registrations for Storybook based on Nuxt's component discovery
 * This script reads .nuxt/types/components.d.ts and generates component-auto-loader.ts
 */

const COMPONENT_TYPES_PATH = ".nuxt/types/components.d.ts"
const OUTPUT_PATH = ".storybook/component-auto-loader.ts"

// Components to exclude from auto-registration (problematic or unnecessary components)
const EXCLUDED_COMPONENTS = new Set([
  "DisplayGridCore", // Has prop validation issues
  // Add more problematic components here
])

// Nuxt framework components that need mocks instead of real imports
const NUXT_FRAMEWORK_COMPONENTS = new Set([
  "Icon",
  "NuxtImg",
  "NuxtLink",
  "ClientOnly",
  "NuxtLayout",
  "NuxtPage",
  "NuxtLoadingIndicator",
  "NuxtErrorBoundary",
  // Add more Nuxt built-ins here
])

async function generateComponentLoader() {
  try {
    console.log("üîç Reading Nuxt component types...")
    const componentTypesContent = await readFile(COMPONENT_TYPES_PATH, "utf-8")

    // Extract component imports using regex
    const componentMatches = componentTypesContent.matchAll(/'([^']+)':\s*typeof import\("([^"]+)"\)\['default'\]/g)

    const components = []
    const componentPaths = {}

    for (const match of componentMatches) {
      const [, componentName, importPath] = match

      // Skip excluded and framework components
      if (EXCLUDED_COMPONENTS.has(componentName) || NUXT_FRAMEWORK_COMPONENTS.has(componentName)) {
        continue
      }

      // Skip Nuxt Scripts components (they're rarely needed in Storybook)
      if (componentName.startsWith("Script") || importPath.includes("@nuxt/scripts")) {
        continue
      }

      components.push(componentName)
      componentPaths[componentName] = importPath
    }

    console.log(`üì¶ Found ${components.length} components to register`)

    // Generate the auto-loader file
    const autoLoaderContent = generateAutoLoaderFile(componentPaths, components)

    await writeFile(OUTPUT_PATH, autoLoaderContent, "utf-8")
    console.log(`‚úÖ Generated ${OUTPUT_PATH} with ${components.length} components`)

    // Log some examples
    console.log("üìù Sample registered components:", components.slice(0, 5).join(", "))
  } catch (error) {
    console.error("‚ùå Failed to generate component loader:", error)
    process.exit(1)
  }
}

function generateAutoLoaderFile(componentPaths, components) {
  return `import type { App } from 'vue'

// ü§ñ AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
// This file is generated by scripts/generate-storybook-components.mjs
// Run 'npm run storybook:generate-components' to regenerate

async function importComponent(path: string) {
  try {
    const component = await import(/* @vite-ignore */ path)
    return component.default
  } catch (error) {
    console.warn(\`Failed to load component from \${path}:\`, error)
    return null
  }
}

// Component paths extracted from .nuxt/types/components.d.ts
const componentPaths = {
${Object.entries(componentPaths)
  .map(([name, path]) => `  ${name}: "${path}",`)
  .join("\n")}
} as const

// All available components (auto-discovered from Nuxt)
const availableComponents = [
${components.map((name) => `  '${name}',`).join("\n")}
] as const

export async function registerComponents(app: App, componentsToRegister?: string[]) {
  // Register all components by default, or only specified ones
  const targetComponents = componentsToRegister || availableComponents

  for (const componentName of targetComponents) {
    const path = componentPaths[componentName as keyof typeof componentPaths]
    if (path) {
      const component = await importComponent(path)
      if (component) {
        app.component(componentName, component)
        console.log(\`‚úÖ Registered component: \${componentName}\`)
      }
    } else {
      console.warn(\`‚ö†Ô∏è  Component \${componentName} not found in component paths\`)
    }
  }
}

// Helper function to register a specific component on demand
export async function registerComponent(app: App, componentName: keyof typeof componentPaths) {
  const path = componentPaths[componentName]
  if (path) {
    const component = await importComponent(path)
    if (component) {
      app.component(componentName, component)
      console.log(\`‚úÖ Registered component: \${componentName}\`)
      return true
    }
  }
  return false
}

export function registerNuxtMocks(app: App) {
  // Mock Nuxt framework components
  app.component('Icon', {
    props: {
      name: { type: String, required: true },
      size: { type: [String, Number], default: '1em' },
    },
    template: \`
      <span
        :style="{
          display: 'inline-block',
          width: typeof size === 'number' ? size + 'px' : size,
          height: typeof size === 'number' ? size + 'px' : size,
          backgroundColor: 'currentColor',
          maskImage: 'url(https://api.iconify.design/' + name.replace(':', '/') + '.svg)',
          maskRepeat: 'no-repeat',
          maskPosition: 'center',
          maskSize: 'contain'
        }"
        :title="name"
      ></span>
    \`,
  })

  app.component('NuxtImg', {
    props: {
      src: { type: String, required: true },
      alt: { type: String, default: '' },
      width: { type: [String, Number] },
      height: { type: [String, Number] },
      loading: { type: String, default: 'lazy' },
    },
    template: \`
      <img
        :src="src"
        :alt="alt"
        :width="width"
        :height="height"
        :loading="loading"
        v-bind="$attrs"
      />
    \`,
  })

  app.component('NuxtLink', {
    props: {
      to: { type: [String, Object], required: true },
      external: { type: Boolean, default: false },
    },
    template: \`
      <a
        :href="typeof to === 'string' ? to : to.path || to.href"
        :target="external ? '_blank' : undefined"
        :rel="external ? 'noopener noreferrer' : undefined"
        v-bind="$attrs"
      >
        <slot />
      </a>
    \`,
  })

  app.component('ClientOnly', {
    template: \`<slot />\`,
  })

  app.component('NuxtLayout', {
    props: {
      name: { type: String, default: 'default' },
    },
    template: \`
      <div class="nuxt-layout">
        <slot />
      </div>
    \`,
  })
}

// Export component info for debugging
export const componentInfo = {
  totalComponents: availableComponents.length,
  availableComponents,
  componentPaths,
}
`
}

// Run the generator
generateComponentLoader()
